<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Твой финкабинет</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg: #020617;
      --card-bg: #020617;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --accent: #3b82f6;
      --accent-text: #f9fafb;
      --border: rgba(148,163,184,0.25);
      --danger: #f97373;
      --success: #4ade80;
    }
    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 8px;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      font-size: 14px;
    }

    .app {
      max-width: 960px;
      margin: 0 auto 24px;
    }

    h1, h2, h3 {
      margin: 0 0 6px;
      font-weight: 600;
    }
    h1 { font-size: 20px; }
    h2 { font-size: 18px; }
    h3 { font-size: 16px; }

    .subtitle {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .card {
      background: var(--card-bg);
      border-radius: 10px;
      padding: 8px;
      margin-bottom: 8px;
      border: 1px solid var(--border);
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 4px;
    }
    .col {
      flex: 1 1 220px;
      min-width: 0;
    }

    label {
      display: block;
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 2px;
    }

    input, select {
      width: 100%;
      padding: 5px 7px;
      border-radius: 8px;
      border: 1px solid #4b5563;
      background: #020617;
      color: var(--text);
      font-size: 13px;
      line-height: 1.2;
    }
    input:focus, select:focus {
      outline: 2px solid var(--accent);
      border-color: var(--accent);
    }

    button {
      border: none;
      border-radius: 9px;
      padding: 6px 12px;
      font-size: 13px;
      cursor: pointer;
      background: var(--accent);
      color: var(--accent-text);
      font-weight: 500;
    }
    button.secondary {
      background: #4b5563;
      color: #e5e7eb;
    }
    button:active { transform: scale(0.97); }

    .list {
      margin-top: 4px;
      max-height: 260px;
      overflow-y: auto;
      padding-right: 3px;
    }

    .item {
      border-radius: 9px;
      padding: 6px;
      background: #020617;
      border: 1px solid #1f2937;
      margin-bottom: 5px;
      font-size: 13px;
    }

    .item-header {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      margin-bottom: 3px;
      font-weight: 500;
    }

    .muted {
      color: var(--muted);
      font-size: 12px;
    }

    .tag {
      display: inline-block;
      padding: 1px 5px;
      border-radius: 999px;
      font-size: 11px;
      background: #1f2937;
      color: var(--text);
      margin-left: 4px;
    }

    .kpi-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .kpi {
      flex: 1 1 160px;
      background: #020617;
      border-radius: 9px;
      padding: 6px;
      border: 1px solid #1f2937;
      font-size: 11px;
    }
    .kpi-label {
      color: var(--muted);
      margin-bottom: 2px;
    }
    .kpi-value {
      font-size: 15px;
      font-weight: 600;
    }
    .danger { color: var(--danger); }
    .success { color: var(--success); }

    .tabs {
      display: flex;
      margin-top: 6px;
      margin-bottom: 8px;
      border-radius: 999px;
      background: #020617;
      padding: 2px;
      border: 1px solid #1f2937;
    }
    .tab {
      flex: 1;
      text-align: center;
      padding: 6px 0;
      border-radius: 999px;
      font-size: 13px;
      cursor: pointer;
      color: var(--muted);
      user-select: none;
    }
    .tab.active {
      background: #111827;
      color: var(--text);
      font-weight: 500;
      box-shadow: 0 0 0 1px rgba(59,130,246,0.3);
    }

    .field-error {
      color: var(--danger);
      font-size: 11px;
      margin-top: 1px;
    }

    .progress {
      width: 100%;
      height: 5px;
      border-radius: 999px;
      background: #111827;
      overflow: hidden;
      margin-top: 2px;
    }
    .progress-bar {
      height: 100%;
      background: #22c55e;
    }

    .details-toggle {
      margin-top: 4px;
      font-size: 12px;
      color: var(--muted);
      cursor: pointer;
      user-select: none;
    }

    @media (max-width: 600px) {
      .row { flex-direction: column; }
      .app { margin-bottom: 16px; }
    }
  </style>
</head>
<body>
<div class="app">
  <h1>Твой финкабинет</h1>
  <p class="subtitle" id="tg-user-label"></p>

  <div class="card">
    <h2>Дашборд</h2>
    <div class="kpi-row" id="dashboard-kpis-main"></div>
    <div id="dashboard-details-toggle" class="details-toggle">
      Показать детали
    </div>
    <div id="dashboard-kpis-details" style="display:none;margin-top:4px;">
      <div class="kpi-row" id="dashboard-kpis-extra"></div>
    </div>
  </div>

  <div class="tabs">
    <div class="tab active" data-tab="deposits" id="tab-btn-deposits">Вклады</div>
    <div class="tab" data-tab="loans" id="tab-btn-loans">Кредиты</div>
    <div class="tab" data-tab="incomes" id="tab-btn-incomes">Доходы</div>
  </div>

  <!-- ВКЛАДЫ -->
  <div id="tab-deposits">
    <div class="card">
      <h3>Добавить вклад</h3>
      <div class="row">
        <div class="col">
          <label>Название</label>
          <input id="dep-name" placeholder="Вклад 10% на 6 мес" />
        </div>
        <div class="col">
          <label>Сумма, ₽</label>
          <input id="dep-amount" type="number" inputmode="decimal" placeholder="Напр. 300000" />
        </div>
        <div class="col">
          <label>Ставка, % годовых</label>
          <input id="dep-rate" type="number" inputmode="decimal" placeholder="Напр. 12" />
        </div>
      </div>
      <div class="row">
        <div class="col">
          <label>Срок</label>
          <input id="dep-term-value" type="number" inputmode="numeric" placeholder="Напр. 6" />
        </div>
        <div class="col">
          <label>Единица срока</label>
          <select id="dep-term-unit">
            <option value="months">месяцев</option>
            <option value="weeks">недель</option>
          </select>
        </div>
        <div class="col">
          <label>Дата начала</label>
          <input id="dep-start-date" type="date" />
        </div>
      </div>
      <div style="margin-top:6px; display:flex; justify-content:flex-end; gap:6px;">
        <button id="dep-add-btn">Сохранить вклад</button>
      </div>
    </div>

    <div class="card">
      <h3>Мои вклады</h3>
      <div class="list" id="dep-list"></div>
    </div>
  </div>

  <!-- КРЕДИТЫ -->
  <div id="tab-loans" style="display:none;">
    <div class="card">
      <h3>Добавить кредит</h3>
      <div class="row">
        <div class="col">
          <label>Название</label>
          <input id="loan-name" placeholder="Кредит Т-Банк" />
        </div>
        <div class="col">
          <label>Сумма кредита, ₽</label>
          <input id="loan-principal" type="number" inputmode="decimal" placeholder="Напр. 500000" />
        </div>
        <div class="col">
          <label>Текущий остаток, ₽</label>
          <input id="loan-balance" type="number" inputmode="decimal" placeholder="если пусто = сумма" />
        </div>
      </div>
      <div class="row">
        <div class="col">
          <label>Ставка, % годовых</label>
          <input id="loan-rate" type="number" inputmode="decimal" placeholder="Напр. 20" />
        </div>
        <div class="col">
          <label>Ежемесячный платёж, ₽</label>
          <input id="loan-monthly" type="number" inputmode="decimal" placeholder="Напр. 15000" />
        </div>
        <div class="col">
          <label>Дата начала</label>
          <input id="loan-start-date" type="date" />
        </div>
      </div>
      <div style="margin-top:6px; display:flex; justify-content:flex-end; gap:6px;">
        <button id="loan-add-btn">Сохранить кредит</button>
      </div>
    </div>

    <div class="card">
      <h3>Мои кредиты</h3>
      <div class="list" id="loan-list"></div>
    </div>
  </div>

  <!-- ДОХОДЫ -->
  <div id="tab-incomes" style="display:none;">
    <div class="card">
      <h3>Добавить доход</h3>
      <div class="row">
        <div class="col">
          <label>Название</label>
          <input id="inc-name" placeholder="Зарплата" />
        </div>
        <div class="col">
          <label>Тип</label>
          <select id="inc-type">
            <option value="salary">Зарплата</option>
            <option value="dividends">Дивиденды</option>
            <option value="interest">Проценты</option>
            <option value="other">Другое</option>
          </select>
        </div>
        <div class="col">
          <label>Сумма, ₽</label>
          <input id="inc-amount" type="number" inputmode="decimal" placeholder="Напр. 120000" />
        </div>
      </div>
      <div class="row">
        <div class="col">
          <label>Дата</label>
          <input id="inc-date" type="date" />
        </div>
        <div class="col">
          <label>Частота</label>
          <select id="inc-frequency">
            <option value="once">Разово</option>
            <option value="monthly">Ежемесячно</option>
            <option value="weekly">Еженедельно</option>
            <option value="yearly">Ежегодно</option>
          </select>
        </div>
      </div>
      <div style="margin-top:6px; display:flex; justify-content:flex-end; gap:6px;">
        <button id="inc-add-btn">Сохранить доход</button>
      </div>
    </div>

    <div class="card">
      <h3>Мои доходы</h3>
      <div class="list" id="inc-list"></div>
    </div>
  </div>
</div>

<script>
  const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
  let currentTab = 'deposits';

  // --- Theme from Telegram ---
  (function applyTheme() {
    if (!tg) return;
    const tp = tg.themeParams || {};
    const root = document.documentElement;

    if (tp.bg_color) root.style.setProperty('--bg', tp.bg_color);
    if (tp.secondary_bg_color) root.style.setProperty('--card-bg', tp.secondary_bg_color);
    if (tp.text_color) root.style.setProperty('--text', tp.text_color);
    if (tp.hint_color) root.style.setProperty('--muted', tp.hint_color);
    if (tp.button_color) root.style.setProperty('--accent', tp.button_color);
    if (tp.button_text_color) root.style.setProperty('--accent-text', tp.button_text_color);
  })();

  // --- Telegram init ---
  (function initTelegram() {
    if (tg) {
      tg.ready();
      tg.expand();
      const user = tg.initDataUnsafe?.user;
      if (user) {
        const label = document.getElementById('tg-user-label');
        label.textContent =
          `Пользователь: ${user.first_name || ''} ${user.last_name || ''}`.trim() +
          (user.username ? ` (@${user.username})` : '');
      }
    } else {
      document.getElementById('tg-user-label').textContent =
        'Открыто вне Telegram (режим разработки).';
    }
  })();

  // --- State & storage ---
  const STORAGE_KEY = 'finCabinetStateV3';

  let state = {
    deposits: [],
    loans: [],
    incomes: []
  };

  function loadState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      const parsed = JSON.parse(raw);
      if (parsed && typeof parsed === 'object') {
        state = {
          deposits: Array.isArray(parsed.deposits) ? parsed.deposits : [],
          loans: Array.isArray(parsed.loans) ? parsed.loans : [],
          incomes: Array.isArray(parsed.incomes) ? parsed.incomes : []
        };
      }
    } catch (e) {
      console.error('Failed to load state', e);
    }
  }

  function saveState() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    renderAll();
  }

  function formatMoney(x) {
    if (isNaN(x)) return '—';
    return new Intl.NumberFormat('ru-RU', {
      style: 'currency',
      currency: 'RUB',
      maximumFractionDigits: 0
    }).format(x);
  }

  function formatDate(date) {
    if (!date) return '—';
    return date.toLocaleDateString('ru-RU');
  }

  function setDefaultDate(id) {
    const el = document.getElementById(id);
    if (!el) return;
    if (!el.value) {
      const today = new Date();
      el.value = today.toISOString().slice(0, 10);
    }
  }

  ['dep-start-date', 'loan-start-date', 'inc-date'].forEach(setDefaultDate);

  // --- Inline errors ---
  function showFieldError(inputEl, msg) {
    if (!inputEl) return;
    let err = inputEl.parentElement.querySelector('.field-error');
    if (!err) {
      err = document.createElement('div');
      err.className = 'field-error';
      inputEl.parentElement.appendChild(err);
    }
    err.textContent = msg;
    const oldBorder = inputEl.style.borderColor;
    inputEl.style.borderColor = 'var(--danger)';
    setTimeout(() => {
      inputEl.style.borderColor = oldBorder || '';
      err.textContent = '';
    }, 2500);
  }

  // --- Business logic: deposits ---
  function calcDeposit(deposit) {
    const amount = Number(deposit.amount) || 0;
    const rate = Number(deposit.rate_apy) || 0;
    const termValue = Number(deposit.term_value) || 0;
    const termUnit = deposit.term_unit || 'months';
    const start = deposit.start_date ? new Date(deposit.start_date) : null;

    let years = 0;
    if (termUnit === 'weeks') {
      years = termValue / 52;
    } else {
      years = termValue / 12;
    }

    const interest = amount * (rate / 100) * years;
    const finalAmount = amount + interest;

    let endDate = null;
    if (start && !isNaN(start.getTime())) {
      endDate = new Date(start.getTime());
      if (termUnit === 'weeks') {
        endDate.setDate(endDate.getDate() + termValue * 7);
      } else {
        endDate.setMonth(endDate.getMonth() + termValue);
      }
    }

    return { interest, finalAmount, endDate };
  }

  // --- Business logic: loans ---
  function calcLoan(loan) {
    const principal = Number(loan.initial_amount) || 0;
    const balance = Number(loan.current_balance) || 0;
    const monthly = Number(loan.monthly_payment) || 0;
    const rate = Number(loan.rate_apy) || 0;
    const start = loan.start_date ? new Date(loan.start_date) : null;

    if (balance <= 0 || monthly <= 0) {
      return { months: 0, payoffDate: null, totalPaid: 0, overpay: 0, progress: 0 };
    }

    let months = Math.ceil(balance / monthly);
    if (rate > 0) {
      months = Math.ceil(months * 1.1);
    }

    let payoffDate = null;
    if (start && !isNaN(start.getTime())) {
      payoffDate = new Date(start.getTime());
      payoffDate.setMonth(payoffDate.getMonth() + months);
    }

    const totalPaid = monthly * months;
    const overpay = totalPaid - principal;
    const progress = principal > 0 ? (principal - balance) / principal : 0;

    return { months, payoffDate, totalPaid, overpay, progress };
  }

  // --- Business logic: incomes ---
  function calcIncomeMonthly(income) {
    const amount = Number(income.amount) || 0;
    switch (income.frequency) {
      case 'monthly':
        return amount;
      case 'weekly':
        return amount * 4.33;
      case 'yearly':
        return amount / 12;
      case 'once':
      default:
        return 0;
    }
  }

  // --- DASHBOARD ---
  function renderDashboard() {
    const mainEl = document.getElementById('dashboard-kpis-main');
    const extraEl = document.getElementById('dashboard-kpis-extra');
    mainEl.innerHTML = '';
    extraEl.innerHTML = '';

    const totalDepositPrincipal = state.deposits.reduce(
      (sum, d) => sum + (Number(d.amount) || 0),
      0
    );
    const totalDepositFinal = state.deposits.reduce((sum, d) => {
      const { finalAmount } = calcDeposit(d);
      return sum + finalAmount;
    }, 0);

    const totalLoanBalance = state.loans.reduce(
      (sum, l) => sum + (Number(l.current_balance) || 0),
      0
    );
    const totalLoanPrincipal = state.loans.reduce(
      (sum, l) => sum + (Number(l.initial_amount) || 0),
      0
    );
    const totalLoanMonthlyPayment = state.loans.reduce(
      (sum, l) => sum + (Number(l.monthly_payment) || 0),
      0
    );

    const totalMonthlyIncome = state.incomes.reduce(
      (sum, inc) => sum + calcIncomeMonthly(inc),
      0
    );

    const netNow = totalDepositPrincipal - totalLoanBalance;
    const netFuture = totalDepositFinal - totalLoanBalance;
    const cashFlow = totalMonthlyIncome - totalLoanMonthlyPayment;

    const dti = totalMonthlyIncome > 0
      ? totalLoanMonthlyPayment / totalMonthlyIncome
      : null;

    const mainKpis = [
      {
        label: 'Net worth сейчас',
        value: formatMoney(netNow),
        cls: netNow >= 0 ? 'success' : 'danger'
      },
      {
        label: 'Net worth в будущем',
        value: formatMoney(netFuture),
        cls: netFuture >= 0 ? 'success' : 'danger'
      },
      {
        label: 'Доходы / мес',
        value: formatMoney(totalMonthlyIncome),
        cls: totalMonthlyIncome >= 0 ? 'success' : ''
      },
      {
        label: 'Платежи по кредитам / мес',
        value: formatMoney(totalLoanMonthlyPayment),
        cls: totalLoanMonthlyPayment > 0 ? 'danger' : ''
      },
      {
        label: 'Чистый поток / мес',
        value: formatMoney(cashFlow),
        cls: cashFlow >= 0 ? 'success' : 'danger'
      }
    ];

    const extraKpis = [
      { label: 'Вклады (сейчас)', value: formatMoney(totalDepositPrincipal) },
      { label: 'Вклады (в конце срока)', value: formatMoney(totalDepositFinal) },
      { label: 'Долги (остаток)', value: formatMoney(totalLoanBalance), cls: totalLoanBalance > 0 ? 'danger' : '' },
      { label: 'Долги (изначально)', value: formatMoney(totalLoanPrincipal) },
      {
        label: 'Долговая нагрузка (DTI)',
        value: dti === null ? '—' : (dti * 100).toFixed(0) + '%',
        cls: dti == null ? '' : dti < 0.3 ? 'success' : dti < 0.5 ? '' : 'danger'
      }
    ];

    function renderKpis(list, container) {
      for (const k of list) {
        const div = document.createElement('div');
        div.className = 'kpi';
        div.innerHTML = `
          <div class="kpi-label">${k.label}</div>
          <div class="kpi-value ${k.cls || ''}">${k.value}</div>
        `;
        container.appendChild(div);
      }
    }

    renderKpis(mainKpis, mainEl);
    renderKpis(extraKpis, extraEl);
  }

  // --- Deposits list ---
  function renderDeposits() {
    const list = document.getElementById('dep-list');
    list.innerHTML = '';

    if (!state.deposits.length) {
      list.innerHTML = '<div class="muted">Вкладов пока нет. Добавь первый выше.</div>';
      return;
    }

    state.deposits.forEach((d, idx) => {
      const { interest, finalAmount, endDate } = calcDeposit(d);
      const unitLabel = d.term_unit === 'weeks' ? 'нед.' : 'мес.';

      const div = document.createElement('div');
      div.className = 'item';

      div.innerHTML = `
        <div class="item-header">
          <span>${d.name || 'Без названия'}</span>
          <span>${formatMoney(Number(d.amount) || 0)}</span>
        </div>
        <div class="muted">
          Ставка: ${d.rate_apy || 0}% • Срок: ${d.term_value || 0} ${unitLabel}
        </div>
        <div class="muted">
          Начало: ${d.start_date || '—'} • Конец: ${formatDate(endDate)}
        </div>
        <div class="muted">
          Доход: <span class="success">${formatMoney(interest)}</span> •
          В конце срока: <b>${formatMoney(finalAmount)}</b>
        </div>
        <div style="margin-top:4px; display:flex; justify-content:flex-end;">
          <button class="secondary" data-remove-dep="${idx}">Удалить</button>
        </div>
      `;

      list.appendChild(div);
    });

    // бейджи с количеством
    document.getElementById('tab-btn-deposits').textContent = `Вклады (${state.deposits.length})`;
  }

  // --- Loans list ---
  function renderLoans() {
    const list = document.getElementById('loan-list');
    list.innerHTML = '';

    if (!state.loans.length) {
      list.innerHTML = '<div class="muted">Кредитов пока нет. Добавь первый выше.</div>';
      return;
    }

    state.loans.forEach((l, idx) => {
      const { months, payoffDate, totalPaid, overpay, progress } = calcLoan(l);

      const div = document.createElement('div');
      div.className = 'item';

      const pct = Math.max(0, Math.min(100, Math.round(progress * 100)));

      div.innerHTML = `
        <div class="item-header">
          <span>${l.name || 'Без названия'}</span>
          <span>${formatMoney(Number(l.current_balance) || 0)}</span>
        </div>
        <div class="muted">
          Ставка: ${l.rate_apy || 0}% • Платёж: ${formatMoney(Number(l.monthly_payment) || 0)} / мес
        </div>
        <div class="muted">
          Старт: ${l.start_date || '—'} • Ориентир закрытия: ${formatDate(payoffDate)} (${months || 0} мес)
        </div>
        <div class="muted">
          Всего выплат: ${formatMoney(totalPaid)} • Переплата:
          <span class="${overpay >= 0 ? 'danger' : ''}">${formatMoney(overpay)}</span>
        </div>
        <div class="muted" style="margin-top:3px;">Прогресс погашения (${pct}%)</div>
        <div class="progress">
          <div class="progress-bar" style="width:${pct}%;"></div>
        </div>
        <div style="margin-top:4px; display:flex; justify-content:flex-end;">
          <button class="secondary" data-remove-loan="${idx}">Удалить</button>
        </div>
      `;

      list.appendChild(div);
    });

    document.getElementById('tab-btn-loans').textContent = `Кредиты (${state.loans.length})`;
  }

  // --- Incomes list ---
  function renderIncomes() {
    const list = document.getElementById('inc-list');
    list.innerHTML = '';

    if (!state.incomes.length) {
      list.innerHTML = '<div class="muted">Доходов пока нет. Добавь первый выше.</div>';
      return;
    }

    const typeMap = {
      salary: 'Зарплата',
      dividends: 'Дивиденды',
      interest: 'Проценты',
      other: 'Другое'
    };
    const freqMap = {
      once: 'разово',
      monthly: 'ежемесячно',
      weekly: 'еженедельно',
      yearly: 'ежегодно'
    };

    state.incomes.forEach((inc, idx) => {
      const monthly = calcIncomeMonthly(inc);

      const div = document.createElement('div');
      div.className = 'item';

      div.innerHTML = `
        <div class="item-header">
          <span>${inc.name || 'Без названия'} <span class="tag">${typeMap[inc.type] || ''}</span></span>
          <span>${formatMoney(Number(inc.amount) || 0)}</span>
        </div>
        <div class="muted">
          Дата: ${inc.date || '—'} • Частота: ${freqMap[inc.frequency] || ''}
        </div>
        <div class="muted">
          Оценка в месяц: <span class="success">${formatMoney(monthly)}</span>
        </div>
        <div style="margin-top:4px; display:flex; justify-content:flex-end;">
          <button class="secondary" data-remove-inc="${idx}">Удалить</button>
        </div>
      `;

      list.appendChild(div);
    });

    document.getElementById('tab-btn-incomes').textContent = `Доходы (${state.incomes.length})`;
  }

  function renderAll() {
    renderDashboard();
    renderDeposits();
    renderLoans();
    renderIncomes();
  }

  // --- Tabs & MainButton ---
  function setTab(tab) {
    currentTab = tab;
    document.querySelectorAll('.tab').forEach(t => {
      t.classList.toggle('active', t.dataset.tab === tab);
    });
    document.getElementById('tab-deposits').style.display = tab === 'deposits' ? '' : 'none';
    document.getElementById('tab-loans').style.display = tab === 'loans' ? '' : 'none';
    document.getElementById('tab-incomes').style.display = tab === 'incomes' ? '' : 'none';

    if (tg) {
      const textMap = {
        deposits: 'Сохранить вклад',
        loans: 'Сохранить кредит',
        incomes: 'Сохранить доход'
      };
      tg.MainButton.setText(textMap[tab] || 'Сохранить');
      tg.MainButton.show();
    }
  }

  document.querySelectorAll('.tab').forEach(tabEl => {
    tabEl.addEventListener('click', () => {
      setTab(tabEl.dataset.tab);
    });
  });

  if (tg) {
    tg.MainButton.onClick(() => {
      if (currentTab === 'deposits') document.getElementById('dep-add-btn').click();
      if (currentTab === 'loans') document.getElementById('loan-add-btn').click();
      if (currentTab === 'incomes') document.getElementById('inc-add-btn').click();
    });
  }

  // --- Dashboard details toggle ---
  document.getElementById('dashboard-details-toggle').addEventListener('click', () => {
    const box = document.getElementById('dashboard-kpis-details');
    const opened = box.style.display !== 'none';
    box.style.display = opened ? 'none' : 'block';
    document.getElementById('dashboard-details-toggle').textContent =
      opened ? 'Показать детали' : 'Скрыть детали';
  });

  // --- Handlers: add deposit ---
  document.getElementById('dep-add-btn').addEventListener('click', () => {
    const name = document.getElementById('dep-name').value.trim();
    const amountEl = document.getElementById('dep-amount');
    const rateEl = document.getElementById('dep-rate');
    const termValEl = document.getElementById('dep-term-value');
    const termUnit = document.getElementById('dep-term-unit').value;
    const startDate = document.getElementById('dep-start-date').value;

    const amount = amountEl.value;
    const rate = rateEl.value;
    const termValue = termValEl.value;

    let ok = true;
    if (!amount) { showFieldError(amountEl, 'Укажи сумму'); ok = false; }
    if (!rate) { showFieldError(rateEl, 'Укажи ставку'); ok = false; }
    if (!termValue) { showFieldError(termValEl, 'Укажи срок'); ok = false; }
    if (!ok) return;

    state.deposits.push({
      id: Date.now(),
      name,
      amount,
      rate_apy: rate,
      term_value: termValue,
      term_unit: termUnit,
      start_date: startDate
    });

    document.getElementById('dep-name').value = '';
    amountEl.value = '';
    rateEl.value = '';
    termValEl.value = '';
    document.getElementById('dep-term-unit').value = 'months';
    setDefaultDate('dep-start-date');

    saveState();
  });

  // --- Handlers: add loan ---
  document.getElementById('loan-add-btn').addEventListener('click', () => {
    const name = document.getElementById('loan-name').value.trim();
    const principalEl = document.getElementById('loan-principal');
    const balanceEl = document.getElementById('loan-balance');
    const rateEl = document.getElementById('loan-rate');
    const monthlyEl = document.getElementById('loan-monthly');
    const startDate = document.getElementById('loan-start-date').value;

    const principal = principalEl.value;
    let balance = balanceEl.value;
    const rate = rateEl.value;
    const monthly = monthlyEl.value;

    let ok = true;
    if (!principal) { showFieldError(principalEl, 'Укажи сумму кредита'); ok = false; }
    if (!monthly) { showFieldError(monthlyEl, 'Укажи ежемесячный платёж'); ok = false; }
    if (!ok) return;

    if (!balance) balance = principal;

    state.loans.push({
      id: Date.now(),
      name,
      initial_amount: principal,
      current_balance: balance,
      rate_apy: rate,
      monthly_payment: monthly,
      start_date: startDate
    });

    document.getElementById('loan-name').value = '';
    principalEl.value = '';
    balanceEl.value = '';
    rateEl.value = '';
    monthlyEl.value = '';
    setDefaultDate('loan-start-date');

    saveState();
  });

  // --- Handlers: add income ---
  document.getElementById('inc-add-btn').addEventListener('click', () => {
    const name = document.getElementById('inc-name').value.trim();
    const type = document.getElementById('inc-type').value;
    const amountEl = document.getElementById('inc-amount');
    const date = document.getElementById('inc-date').value;
    const freq = document.getElementById('inc-frequency').value;

    const amount = amountEl.value;
    if (!amount) {
      showFieldError(amountEl, 'Укажи сумму дохода');
      return;
    }

    state.incomes.push({
      id: Date.now(),
      name,
      type,
      amount,
      date,
      frequency: freq
    });

    document.getElementById('inc-name').value = '';
    amountEl.value = '';
    setDefaultDate('inc-date');
    document.getElementById('inc-type').value = 'salary';
    document.getElementById('inc-frequency').value = 'once';

    saveState();
  });

  // --- Deletes ---
  document.getElementById('dep-list').addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-remove-dep]');
    if (!btn) return;
    const idx = Number(btn.getAttribute('data-remove-dep'));
    const item = state.deposits[idx];
    if (!isNaN(idx) && item) {
      const title = item.name || 'вклад';
      if (confirm(`Удалить ${title}?`)) {
        state.deposits.splice(idx, 1);
        saveState();
      }
    }
  });

  document.getElementById('loan-list').addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-remove-loan]');
    if (!btn) return;
    const idx = Number(btn.getAttribute('data-remove-loan'));
    const item = state.loans[idx];
    if (!isNaN(idx) && item) {
      const title = item.name || 'кредит';
      if (confirm(`Удалить ${title}?`)) {
        state.loans.splice(idx, 1);
        saveState();
      }
    }
  });

  document.getElementById('inc-list').addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-remove-inc]');
    if (!btn) return;
    const idx = Number(btn.getAttribute('data-remove-inc'));
    const item = state.incomes[idx];
    if (!isNaN(idx) && item) {
      const title = item.name || 'доход';
      if (confirm(`Удалить ${title}?`)) {
        state.incomes.splice(idx, 1);
        saveState();
      }
    }
  });

  // --- Init ---
  loadState();
  renderAll();
  setTab('deposits');
</script>
</body>
</html>



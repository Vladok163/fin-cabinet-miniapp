<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–¢–≤–æ–π —Ñ–∏–Ω–∫–∞–±–∏–Ω–µ—Ç</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg: #020617;
      --card-bg: #020617;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --accent: #3b82f6;
      --accent-text: #f9fafb;
      --border: rgba(148,163,184,0.25);
      --danger: #f97373;
      --success: #4ade80;
      --transition-bounce: cubic-bezier(0.68,-0.55,0.27,1.55);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 8px;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      font-size: 14px;
    }

    .app {
      max-width: 960px;
      margin: 0 auto 24px;
    }

    h1, h2, h3 {
      margin: 0 0 6px;
      font-weight: 600;
    }
    h1 { font-size: 20px; }
    h2 { font-size: 18px; }
    h3 { font-size: 16px; }

    .subtitle {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .card {
      background: var(--card-bg);
      border-radius: 10px;
      padding: 8px;
      margin-bottom: 8px;
      border: 1px solid var(--border);
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 2px; /* —É–º–µ–Ω—å—à–∏–ª –æ—Ç—Å—Ç—É–ø –º–µ–∂–¥—É —Å—Ç—Ä–æ–∫–∞–º–∏ */
    }
    .col {
      flex: 1 1 220px;
      min-width: 0;
    }

    label {
      display: block;
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 2px;
    }

    input, select {
      width: 100%;
      padding: 4px 7px; /* —á—É—Ç—å –∫–æ–º–ø–∞–∫—Ç–Ω–µ–µ */
      border-radius: 8px;
      border: 1px solid #4b5563;
      background: #020617;
      color: var(--text);
      font-size: 13px;
      line-height: 1.2;
    }
    input:focus, select:focus {
      outline: 2px solid var(--accent);
      border-color: var(--accent);
    }

    button {
      border: none;
      border-radius: 9px;
      padding: 6px 12px;
      font-size: 13px;
      cursor: pointer;
      background: var(--accent);
      color: var(--accent-text);
      font-weight: 500;
    }
    button.secondary {
      background: #4b5563;
      color: #e5e7eb;
    }
    button:active { transform: scale(0.97); }

    .list {
      margin-top: 4px;
      max-height: 260px;
      overflow-y: auto;
      padding-right: 3px;
    }

    .item {
      border-radius: 9px;
      padding: 6px;
      background: #020617;
      border: 1px solid #1f2937;
      margin-bottom: 5px;
      font-size: 13px;
      opacity: 0;
      animation: fadeInUp 0.3s ease-out forwards;
    }
    .item.new-add {
      animation: slideInRight 0.35s var(--transition-bounce) forwards, highlightPulse 0.8s ease-out;
    }

    .item-header {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      margin-bottom: 3px;
      font-weight: 500;
    }

    .muted {
      color: var(--muted);
      font-size: 12px;
    }

    .tag {
      display: inline-block;
      padding: 1px 5px;
      border-radius: 999px;
      font-size: 11px;
      background: #1f2937;
      color: #f9fafb;
      margin-left: 4px;
    }

    .kpi-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .kpi {
      flex: 1 1 160px;
      background: #020617;
      border-radius: 9px;
      padding: 6px;
      border: 1px solid #1f2937;
      font-size: 11px;
    }
    .kpi-label {
      color: var(--muted);
      margin-bottom: 2px;
    }
    .kpi-value {
      font-size: 15px;
      font-weight: 600;
    }
    .danger { color: var(--danger); }
    .success { color: var(--success); }

    .tabs {
      display: flex;
      margin-top: 6px;
      margin-bottom: 8px;
      border-radius: 999px;
      background: #020617;
      padding: 2px;
      border: 1px solid #1f2937;
    }
    .tab {
      flex: 1;
      text-align: center;
      padding: 6px 0;
      border-radius: 999px;
      font-size: 13px;
      cursor: pointer;
      color: var(--muted);
      user-select: none;
    }
    .tab.active {
      background: #111827;
      color: var(--text);
      font-weight: 500;
      box-shadow: 0 0 0 1px rgba(59,130,246,0.3);
    }

    .field-error {
      color: var(--danger);
      font-size: 11px;
      margin-top: 1px;
    }

    .progress {
      width: 100%;
      height: 5px;
      border-radius: 999px;
      background: #111827;
      overflow: hidden;
      margin-top: 2px;
    }
    .progress-bar {
      height: 100%;
      background: #22c55e;
    }

    .details-toggle {
      margin-top: 4px;
      font-size: 12px;
      color: var(--muted);
      cursor: pointer;
      user-select: none;
    }

    /* –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –≤–∫–ª–∞–¥–∞ */
    .dep-preview {
      margin-top: 6px;
      border-radius: 8px;
      border: 1px dashed var(--border);
      padding: 6px;
      font-size: 12px;
    }
    .dep-preview-title {
      font-weight: 500;
      margin-bottom: 4px;
    }
    .dep-preview-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .dep-preview-item {
      flex: 1 1 120px;
      min-width: 0;
    }
    .dep-preview-label {
      color: var(--muted);
      font-size: 11px;
      margin-bottom: 1px;
    }
    .dep-preview-value {
      font-size: 13px;
      font-weight: 500;
    }

    .form-actions {
      margin-top: 6px;
      display: flex;
      justify-content: flex-end;
      gap: 6px;
    }

    /* –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ */
    .empty-state {
      text-align: left;
      padding: 6px;
      border-radius: 8px;
      border: 1px dashed var(--border);
      background: #020617;
      font-size: 13px;
    }
    .empty-state h3 {
      margin: 0 0 4px;
      font-size: 14px;
    }
    .empty-state-description {
      margin: 0 0 6px;
      font-size: 12px;
      color: var(--muted);
    }
    .suggestion-card {
      border-radius: 8px;
      border: 1px solid #1f2937;
      padding: 6px;
      margin-top: 4px;
    }
    .suggestion-header {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-bottom: 2px;
      font-size: 13px;
    }
    .suggestion-emoji {
      font-size: 14px;
    }
    .btn-suggestion {
      margin-top: 4px;
      padding: 4px 8px;
      font-size: 12px;
      border-radius: 999px;
      border: none;
      background: #3b82f6;
      color: #f9fafb;
      cursor: pointer;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(6px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(12px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    @keyframes highlightPulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(59,130,246,0); }
      50% { box-shadow: 0 0 0 4px rgba(59,130,246,0.35); }
    }

.row-full .col {
  flex: 1 1 100%;
}

/* –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è: —Å—Ç—Ä–æ–∫–∏ –æ—Å—Ç–∞—é—Ç—Å—è –≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç–æ–ª–±—Ü–æ–≤ */
@media (max-width: 600px) {
  .col {
    flex: 1 1 48%;   /* –º–∞–∫—Å–∏–º—É–º 2 –ø–æ–ª—è –≤ —Å—Ç—Ä–æ–∫–µ, —Ç—Ä–µ—Ç—å–µ –ø–µ—Ä–µ–Ω–µ—Å—ë—Ç—Å—è –≤–Ω–∏–∑ */
  }
  .row {
    gap: 4px;
  }
  .app {
    margin-bottom: 16px;
  }
}
  </style>
</head>
<body>
<div class="app">
  <h1>–¢–≤–æ–π —Ñ–∏–Ω–∫–∞–±–∏–Ω–µ—Ç</h1>
  <p class="subtitle" id="tg-user-label"></p>

  <!-- –î–ê–®–ë–û–†–î 2.0 -->
  <div class="card">
    <h2>–§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –ø–∞–Ω–æ—Ä–∞–º–∞</h2>
    <div class="kpi-row" id="dashboard-kpis-main"></div>
    <div id="dashboard-details-toggle" class="details-toggle">
      –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏
    </div>
    <div id="dashboard-kpis-details" style="display:none;margin-top:4px;">
      <div class="kpi-row" id="dashboard-kpis-extra"></div>
    </div>
  </div>

  <div class="tabs">
    <div class="tab active" data-tab="deposits" id="tab-btn-deposits">–í–∫–ª–∞–¥—ã</div>
    <div class="tab" data-tab="loans" id="tab-btn-loans">–ö—Ä–µ–¥–∏—Ç—ã</div>
    <div class="tab" data-tab="incomes" id="tab-btn-incomes">–î–æ—Ö–æ–¥—ã</div>
  </div>

  <!-- –í–ö–õ–ê–î–´ -->
  <div id="tab-deposits">
    <div class="card">
      <h3>–î–æ–±–∞–≤–∏—Ç—å –≤–∫–ª–∞–¥</h3>
      <div class="row">
        <div class="col">
          <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
          <input id="dep-name" placeholder="–í–∫–ª–∞–¥ 10% –Ω–∞ 6 –º–µ—Å" />
        </div>
        <div class="col">
          <label>–°—É–º–º–∞, ‚ÇΩ</label>
          <input id="dep-amount" type="number" inputmode="decimal" placeholder="–ù–∞–ø—Ä. 300000" />
        </div>
        <div class="col">
          <label>–°—Ç–∞–≤–∫–∞, % –≥–æ–¥–æ–≤—ã—Ö</label>
          <input id="dep-rate" type="number" inputmode="decimal" placeholder="–ù–∞–ø—Ä. 12" />
        </div>
      </div>
      <div class="row">
        <div class="col">
          <label>–°—Ä–æ–∫</label>
          <input id="dep-term-value" type="number" inputmode="numeric" placeholder="–ù–∞–ø—Ä. 6" />
        </div>
        <div class="col">
          <label>–ï–¥–∏–Ω–∏—Ü–∞ —Å—Ä–æ–∫–∞</label>
          <select id="dep-term-unit">
            <option value="months">–º–µ—Å—è—Ü–µ–≤</option>
            <option value="weeks">–Ω–µ–¥–µ–ª—å</option>
          </select>
        </div>
        <div class="col">
          <label>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</label>
          <input id="dep-start-date" type="date" />
        </div>
      </div>

      <!-- –ü–†–ï–î–ü–†–û–°–ú–û–¢–† –í–ö–õ–ê–î–ê -->
      <div class="dep-preview" id="dep-preview" style="display:none;">
        <div class="dep-preview-title">–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç</div>
        <div class="dep-preview-grid">
          <div class="dep-preview-item">
            <div class="dep-preview-label">–ë—É–¥—É—â–∞—è —Å—É–º–º–∞</div>
            <div class="dep-preview-value" id="dep-preview-future">‚Äî</div>
          </div>
          <div class="dep-preview-item">
            <div class="dep-preview-label">–î–æ—Ö–æ–¥ –≤—Å–µ–≥–æ</div>
            <div class="dep-preview-value success" id="dep-preview-profit">‚Äî</div>
          </div>
          <div class="dep-preview-item">
            <div class="dep-preview-label">–°—Ä–µ–¥–Ω–∏–π –¥–æ—Ö–æ–¥ / –º–µ—Å</div>
            <div class="dep-preview-value" id="dep-preview-monthly">‚Äî</div>
          </div>
        </div>
      </div>

      <div class="form-actions">
        <button class="secondary" id="dep-reset-btn">–û—á–∏—Å—Ç–∏—Ç—å</button>
        <button id="dep-add-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–∫–ª–∞–¥</button>
      </div>
    </div>

    <div class="card">
      <h3>–ú–æ–∏ –≤–∫–ª–∞–¥—ã</h3>
      <div class="list" id="dep-list"></div>
    </div>
  </div>

  <!-- –ö–†–ï–î–ò–¢–´ -->
  <div id="tab-loans" style="display:none;">
    <div class="card">
      <h3>–î–æ–±–∞–≤–∏—Ç—å –∫—Ä–µ–¥–∏—Ç</h3>
      <div class="row">
        <div class="col">
          <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
          <input id="loan-name" placeholder="–ö—Ä–µ–¥–∏—Ç –¢-–ë–∞–Ω–∫" />
        </div>
        <div class="col">
          <label>–°—É–º–º–∞ –∫—Ä–µ–¥–∏—Ç–∞, ‚ÇΩ</label>
          <input id="loan-principal" type="number" inputmode="decimal" placeholder="–ù–∞–ø—Ä. 500000" />
        </div>
        <div class="col">
          <label>–¢–µ–∫—É—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫, ‚ÇΩ</label>
          <input id="loan-balance" type="number" inputmode="decimal" placeholder="–µ—Å–ª–∏ –ø—É—Å—Ç–æ = —Å—É–º–º–∞" />
        </div>
      </div>
      <div class="row">
        <div class="col">
          <label>–°—Ç–∞–≤–∫–∞, % –≥–æ–¥–æ–≤—ã—Ö</label>
          <input id="loan-rate" type="number" inputmode="decimal" placeholder="–ù–∞–ø—Ä. 20" />
        </div>
        <div class="col">
          <label>–ï–∂–µ–º–µ—Å—è—á–Ω—ã–π –ø–ª–∞—Ç—ë–∂, ‚ÇΩ</label>
          <input id="loan-monthly" type="number" inputmode="decimal" placeholder="–ù–∞–ø—Ä. 15000" />
        </div>
        <div class="col">
          <label>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</label>
          <input id="loan-start-date" type="date" />
        </div>
      </div>
      <div class="form-actions">
        <button id="loan-add-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫—Ä–µ–¥–∏—Ç</button>
      </div>
    </div>

    <div class="card">
      <h3>–ú–æ–∏ –∫—Ä–µ–¥–∏—Ç—ã</h3>
      <div class="list" id="loan-list"></div>
    </div>
  </div>

  <!-- –î–û–•–û–î–´ -->
  <div id="tab-incomes" style="display:none;">
    <div class="card">
      <h3>–î–æ–±–∞–≤–∏—Ç—å –¥–æ—Ö–æ–¥</h3>
      <div class="row">
        <div class="col">
          <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
          <input id="inc-name" placeholder="–ó–∞—Ä–ø–ª–∞—Ç–∞" />
        </div>
        <div class="col">
          <label>–¢–∏–ø</label>
          <select id="inc-type">
            <option value="salary">–ó–∞—Ä–ø–ª–∞—Ç–∞</option>
            <option value="dividends">–î–∏–≤–∏–¥–µ–Ω–¥—ã</option>
            <option value="interest">–ü—Ä–æ—Ü–µ–Ω—Ç—ã</option>
            <option value="other">–î—Ä—É–≥–æ–µ</option>
          </select>
        </div>
        <div class="col">
          <label>–°—É–º–º–∞, ‚ÇΩ</label>
          <input id="inc-amount" type="number" inputmode="decimal" placeholder="–ù–∞–ø—Ä. 120000" />
        </div>
      </div>
      <div class="row">
        <div class="col">
          <label>–î–∞—Ç–∞</label>
          <input id="inc-date" type="date" />
        </div>
        <div class="col">
          <label>–ß–∞—Å—Ç–æ—Ç–∞</label>
          <select id="inc-frequency">
            <option value="once">–†–∞–∑–æ–≤–æ</option>
            <option value="monthly">–ï–∂–µ–º–µ—Å—è—á–Ω–æ</option>
            <option value="weekly">–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ</option>
            <option value="yearly">–ï–∂–µ–≥–æ–¥–Ω–æ</option>
          </select>
        </div>
      </div>
      <div class="form-actions">
        <button id="inc-add-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–æ—Ö–æ–¥</button>
      </div>
    </div>

    <div class="card">
      <h3>–ú–æ–∏ –¥–æ—Ö–æ–¥—ã</h3>
      <div class="list" id="inc-list"></div>
    </div>
  </div>
</div>

<script>
  const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
  let currentTab = 'deposits';
  let lastAdded = { type: null, id: null };

  // --- Theme from Telegram ---
  (function applyTheme() {
    if (!tg) return;
    const tp = tg.themeParams || {};
    const root = document.documentElement;

    if (tp.bg_color) root.style.setProperty('--bg', tp.bg_color);
    if (tp.secondary_bg_color) root.style.setProperty('--card-bg', tp.secondary_bg_color);
    if (tp.text_color) root.style.setProperty('--text', tp.text_color);
    if (tp.hint_color) root.style.setProperty('--muted', tp.hint_color);
    if (tp.button_color) root.style.setProperty('--accent', tp.button_color);
    if (tp.button_text_color) root.style.setProperty('--accent-text', tp.button_text_color);
  })();

  // --- Telegram init ---
  (function initTelegram() {
    if (tg) {
      tg.ready();
      tg.expand();
      const user = tg.initDataUnsafe?.user;
      if (user) {
        const label = document.getElementById('tg-user-label');
        label.textContent =
          `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${user.first_name || ''} ${user.last_name || ''}`.trim() +
          (user.username ? ` (@${user.username})` : '');
      }
    } else {
      document.getElementById('tg-user-label').textContent =
        '–û—Ç–∫—Ä—ã—Ç–æ –≤–Ω–µ Telegram (—Ä–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏).';
    }
  })();

  // --- State & storage ---
  const STORAGE_KEY = 'finCabinetStateV3';

  let state = {
    deposits: [],
    loans: [],
    incomes: []
  };

  function loadState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      const parsed = JSON.parse(raw);
      if (parsed && typeof parsed === 'object') {
        state = {
          deposits: Array.isArray(parsed.deposits) ? parsed.deposits : [],
          loans: Array.isArray(parsed.loans) ? parsed.loans : [],
          incomes: Array.isArray(parsed.incomes) ? parsed.incomes : []
        };
      }
    } catch (e) {
      console.error('Failed to load state', e);
    }
  }

  function saveState() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    renderAll();
  }

  function formatMoney(x) {
    if (isNaN(x)) return '‚Äî';
    return new Intl.NumberFormat('ru-RU', {
      style: 'currency',
      currency: 'RUB',
      maximumFractionDigits: 0
    }).format(x);
  }

  function formatDate(date) {
    if (!date) return '‚Äî';
    return date.toLocaleDateString('ru-RU');
  }

  function setDefaultDate(id) {
    const el = document.getElementById(id);
    if (!el) return;
    if (!el.value) {
      const today = new Date();
      el.value = today.toISOString().slice(0, 10);
    }
  }

  ['dep-start-date', 'loan-start-date', 'inc-date'].forEach(setDefaultDate);

  // --- Inline errors ---
  function showFieldError(inputEl, msg) {
    if (!inputEl) return;
    let err = inputEl.parentElement.querySelector('.field-error');
    if (!err) {
      err = document.createElement('div');
      err.className = 'field-error';
      inputEl.parentElement.appendChild(err);
    }
    err.textContent = msg;
    const oldBorder = inputEl.style.borderColor;
    inputEl.style.borderColor = 'var(--danger)';
    setTimeout(() => {
      inputEl.style.borderColor = oldBorder || '';
      err.textContent = '';
    }, 2500);
  }

  // --- Business logic: deposits ---
  function calcDeposit(deposit) {
    const amount = Number(deposit.amount) || 0;
    const rate = Number(deposit.rate_apy) || 0;
    const termValue = Number(deposit.term_value) || 0;
    const termUnit = deposit.term_unit || 'months';
    const start = deposit.start_date ? new Date(deposit.start_date) : null;

    let years = 0;
    if (termUnit === 'weeks') {
      years = termValue / 52;
    } else {
      years = termValue / 12;
    }

    const interest = amount * (rate / 100) * years;
    const finalAmount = amount + interest;

    let endDate = null;
    if (start && !isNaN(start.getTime())) {
      endDate = new Date(start.getTime());
      if (termUnit === 'weeks') {
        endDate.setDate(endDate.getDate() + termValue * 7);
      } else {
        endDate.setMonth(endDate.getMonth() + termValue);
      }
    }

    const months = years * 12;
    const monthlyProfit = months > 0 ? interest / months : 0;

    return { interest, finalAmount, endDate, months, monthlyProfit };
  }

  // --- Business logic: loans ---
  function calcLoan(loan) {
    const principal = Number(loan.initial_amount) || 0;
    const balance = Number(loan.current_balance) || 0;
    const monthly = Number(loan.monthly_payment) || 0;
    const rate = Number(loan.rate_apy) || 0;
    const start = loan.start_date ? new Date(loan.start_date) : null;

    if (balance <= 0 || monthly <= 0) {
      return { months: 0, payoffDate: null, totalPaid: 0, overpay: 0, progress: 0 };
    }

    let months = Math.ceil(balance / monthly);
    if (rate > 0) {
      months = Math.ceil(months * 1.1);
    }

    let payoffDate = null;
    if (start && !isNaN(start.getTime())) {
      payoffDate = new Date(start.getTime());
      payoffDate.setMonth(payoffDate.getMonth() + months);
    }

    const totalPaid = monthly * months;
    const overpay = totalPaid - principal;
    const progress = principal > 0 ? (principal - balance) / principal : 0;

    return { months, payoffDate, totalPaid, overpay, progress };
  }

  // --- Business logic: incomes ---
  function calcIncomeMonthly(income) {
    const amount = Number(income.amount) || 0;
    switch (income.frequency) {
      case 'monthly':
        return amount;
      case 'weekly':
        return amount * 4.33;
      case 'yearly':
        return amount / 12;
      case 'once':
      default:
        return 0;
    }
  }

  // --- DASHBOARD 2.0 ---
  function renderDashboard() {
    const mainEl = document.getElementById('dashboard-kpis-main');
    const extraEl = document.getElementById('dashboard-kpis-extra');
    mainEl.innerHTML = '';
    extraEl.innerHTML = '';

    const totalDepositPrincipal = state.deposits.reduce(
      (sum, d) => sum + (Number(d.amount) || 0),
      0
    );
    const totalDepositFinal = state.deposits.reduce((sum, d) => {
      const { finalAmount } = calcDeposit(d);
      return sum + finalAmount;
    }, 0);

    const totalLoanBalance = state.loans.reduce(
      (sum, l) => sum + (Number(l.current_balance) || 0),
      0
    );
    const totalLoanPrincipal = state.loans.reduce(
      (sum, l) => sum + (Number(l.initial_amount) || 0),
      0
    );
    const totalLoanMonthlyPayment = state.loans.reduce(
      (sum, l) => sum + (Number(l.monthly_payment) || 0),
      0
    );

    const totalMonthlyIncome = state.incomes.reduce(
      (sum, inc) => sum + calcIncomeMonthly(inc),
      0
    );

    const netNow = totalDepositPrincipal - totalLoanBalance;
    const netFuture = totalDepositFinal - totalLoanBalance;
    const cashFlow = totalMonthlyIncome - totalLoanMonthlyPayment;

    const dti = totalMonthlyIncome > 0
      ? totalLoanMonthlyPayment / totalMonthlyIncome
      : null;

    const mainKpis = [
      {
        label: 'Net worth —Å–µ–π—á–∞—Å',
        value: formatMoney(netNow),
        cls: netNow >= 0 ? 'success' : 'danger'
      },
      {
        label: '–ß–∏—Å—Ç—ã–π –ø–æ—Ç–æ–∫ / –º–µ—Å',
        value: formatMoney(cashFlow),
        cls: cashFlow >= 0 ? 'success' : 'danger'
      },
      {
        label: '–î–æ–ª–≥–æ–≤–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ (DTI)',
        value: dti === null ? '‚Äî' : (dti * 100).toFixed(0) + '%',
        cls: dti == null ? '' : dti < 0.3 ? 'success' : dti < 0.5 ? '' : 'danger'
      }
    ];

    const extraKpis = [
      { label: '–í–∫–ª–∞–¥—ã (—Å–µ–π—á–∞—Å)', value: formatMoney(totalDepositPrincipal) },
      { label: '–í–∫–ª–∞–¥—ã (–≤ –∫–æ–Ω—Ü–µ —Å—Ä–æ–∫–∞)', value: formatMoney(totalDepositFinal) },
      { label: '–î–æ–ª–≥–∏ (–æ—Å—Ç–∞—Ç–æ–∫)', value: formatMoney(totalLoanBalance), cls: totalLoanBalance > 0 ? 'danger' : '' },
      { label: '–î–æ–ª–≥–∏ (–∏–∑–Ω–∞—á–∞–ª—å–Ω–æ)', value: formatMoney(totalLoanPrincipal) },
      {
        label: '–î–æ—Ö–æ–¥—ã / –º–µ—Å',
        value: formatMoney(totalMonthlyIncome),
        cls: totalMonthlyIncome >= 0 ? 'success' : ''
      },
      {
        label: '–ü–ª–∞—Ç–µ–∂–∏ –ø–æ –∫—Ä–µ–¥–∏—Ç–∞–º / –º–µ—Å',
        value: formatMoney(totalLoanMonthlyPayment),
        cls: totalLoanMonthlyPayment > 0 ? 'danger' : ''
      },
      {
        label: 'Net worth –≤ –±—É–¥—É—â–µ–º',
        value: formatMoney(netFuture),
        cls: netFuture >= 0 ? 'success' : 'danger'
      }
    ];

    function renderKpis(list, container) {
      for (const k of list) {
        const div = document.createElement('div');
        div.className = 'kpi';
        div.innerHTML = `
          <div class="kpi-label">${k.label}</div>
          <div class="kpi-value ${k.cls || ''}">${k.value}</div>
        `;
        container.appendChild(div);
      }
    }

    renderKpis(mainKpis, mainEl);
    renderKpis(extraKpis, extraEl);
  }

  // --- Deposits list + empty state ---
  function renderDeposits() {
    const list = document.getElementById('dep-list');
    list.innerHTML = '';

    if (!state.deposits.length) {
      list.innerHTML = `
        <div class="empty-state">
          <h3>–ö–∞–ø–∏—Ç–∞–ª –≤ –æ–∂–∏–¥–∞–Ω–∏–∏</h3>
          <p class="empty-state-description">
            –ó–¥–µ—Å—å –±—É–¥—É—Ç –≤–∞—à–∏ –≤–∫–ª–∞–¥—ã. –ù–∞—á–Ω–∏—Ç–µ —Å –ø–µ—Ä–≤–æ–≥–æ ‚Äî —ç—Ç–æ –∑–∞–π–º—ë—Ç –º–µ–Ω—å—à–µ –º–∏–Ω—É—Ç—ã.
          </p>
          <div class="suggestion-card" data-suggestion="deposit-50k">
            <div class="suggestion-header">
              <span class="suggestion-emoji">üöÄ</span>
              <strong>–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç</strong>
            </div>
            <p>–í–∫–ª–∞–¥ 50 000 ‚ÇΩ –Ω–∞ 6 –º–µ—Å—è—Ü–µ–≤ –ø–æ–¥ 8% –≥–æ–¥–æ–≤—ã—Ö.</p>
            <button class="btn-suggestion" onclick="applyDepositSuggestion(50000, 8, 6)">
              –ü—Ä–∏–º–µ–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω
            </button>
          </div>
        </div>
      `;
      document.getElementById('tab-btn-deposits').textContent = `–í–∫–ª–∞–¥—ã (0)`;
      return;
    }

    state.deposits.forEach((d, idx) => {
      const { interest, finalAmount, endDate } = calcDeposit(d);
      const unitLabel = d.term_unit === 'weeks' ? '–Ω–µ–¥.' : '–º–µ—Å.';
      const isNew = lastAdded.type === 'dep' && lastAdded.id === d.id;

      const div = document.createElement('div');
      div.className = 'item' + (isNew ? ' new-add' : '');

      div.innerHTML = `
        <div class="item-header">
          <span>${d.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</span>
          <span>${formatMoney(Number(d.amount) || 0)}</span>
        </div>
        <div class="muted">
          –°—Ç–∞–≤–∫–∞: ${d.rate_apy || 0}% ‚Ä¢ –°—Ä–æ–∫: ${d.term_value || 0} ${unitLabel}
        </div>
        <div class="muted">
          –ù–∞—á–∞–ª–æ: ${d.start_date || '‚Äî'} ‚Ä¢ –ö–æ–Ω–µ—Ü: ${formatDate(endDate)}
        </div>
        <div class="muted">
          –î–æ—Ö–æ–¥: <span class="success">${formatMoney(interest)}</span> ‚Ä¢
          –í –∫–æ–Ω—Ü–µ —Å—Ä–æ–∫–∞: <b>${formatMoney(finalAmount)}</b>
        </div>
        <div style="margin-top:4px; display:flex; justify-content:flex-end;">
          <button class="secondary" data-remove-dep="${idx}">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
      `;

      list.appendChild(div);
    });

    document.getElementById('tab-btn-deposits').textContent = `–í–∫–ª–∞–¥—ã (${state.deposits.length})`;
  }

  // --- Loans list ---
  function renderLoans() {
    const list = document.getElementById('loan-list');
    list.innerHTML = '';

    if (!state.loans.length) {
      list.innerHTML = '<div class="muted">–ö—Ä–µ–¥–∏—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç. –î–æ–±–∞–≤—å –ø–µ—Ä–≤—ã–π –≤—ã—à–µ.</div>';
      document.getElementById('tab-btn-loans').textContent = `–ö—Ä–µ–¥–∏—Ç—ã (0)`;
      return;
    }

    state.loans.forEach((l, idx) => {
      const { months, payoffDate, totalPaid, overpay, progress } = calcLoan(l);
      const isNew = lastAdded.type === 'loan' && lastAdded.id === l.id;

      const div = document.createElement('div');
      div.className = 'item' + (isNew ? ' new-add' : '');

      const pct = Math.max(0, Math.min(100, Math.round(progress * 100)));

      div.innerHTML = `
        <div class="item-header">
          <span>${l.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</span>
          <span>${formatMoney(Number(l.current_balance) || 0)}</span>
        </div>
        <div class="muted">
          –°—Ç–∞–≤–∫–∞: ${l.rate_apy || 0}% ‚Ä¢ –ü–ª–∞—Ç—ë–∂: ${formatMoney(Number(l.monthly_payment) || 0)} / –º–µ—Å
        </div>
        <div class="muted">
          –°—Ç–∞—Ä—Ç: ${l.start_date || '‚Äî'} ‚Ä¢ –û—Ä–∏–µ–Ω—Ç–∏—Ä –∑–∞–∫—Ä—ã—Ç–∏—è: ${formatDate(payoffDate)} (${months || 0} –º–µ—Å)
        </div>
        <div class="muted">
          –í—Å–µ–≥–æ –≤—ã–ø–ª–∞—Ç: ${formatMoney(totalPaid)} ‚Ä¢ –ü–µ—Ä–µ–ø–ª–∞—Ç–∞:
          <span class="${overpay >= 0 ? 'danger' : ''}">${formatMoney(overpay)}</span>
        </div>
        <div class="muted" style="margin-top:3px;">–ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ–≥–∞—à–µ–Ω–∏—è (${pct}%)</div>
        <div class="progress">
          <div class="progress-bar" style="width:${pct}%;"></div>
        </div>
        <div style="margin-top:4px; display:flex; justify-content:flex-end;">
          <button class="secondary" data-remove-loan="${idx}">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
      `;

      list.appendChild(div);
    });

    document.getElementById('tab-btn-loans').textContent = `–ö—Ä–µ–¥–∏—Ç—ã (${state.loans.length})`;
  }

  // --- Incomes list ---
  function renderIncomes() {
    const list = document.getElementById('inc-list');
    list.innerHTML = '';

    if (!state.incomes.length) {
      list.innerHTML = '<div class="muted">–î–æ—Ö–æ–¥–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç. –î–æ–±–∞–≤—å –ø–µ—Ä–≤—ã–π –≤—ã—à–µ.</div>';
      document.getElementById('tab-btn-incomes').textContent = `–î–æ—Ö–æ–¥—ã (0)`;
      return;
    }

    const typeMap = {
      salary: '–ó–∞—Ä–ø–ª–∞—Ç–∞',
      dividends: '–î–∏–≤–∏–¥–µ–Ω–¥—ã',
      interest: '–ü—Ä–æ—Ü–µ–Ω—Ç—ã',
      other: '–î—Ä—É–≥–æ–µ'
    };
    const freqMap = {
      once: '—Ä–∞–∑–æ–≤–æ',
      monthly: '–µ–∂–µ–º–µ—Å—è—á–Ω–æ',
      weekly: '–µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ',
      yearly: '–µ–∂–µ–≥–æ–¥–Ω–æ'
    };

    state.incomes.forEach((inc, idx) => {
      const monthly = calcIncomeMonthly(inc);
      const isNew = lastAdded.type === 'inc' && lastAdded.id === inc.id;

      const div = document.createElement('div');
      div.className = 'item' + (isNew ? ' new-add' : '');

      div.innerHTML = `
        <div class="item-header">
          <span>${inc.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'} <span class="tag">${typeMap[inc.type] || ''}</span></span>
          <span>${formatMoney(Number(inc.amount) || 0)}</span>
        </div>
        <div class="muted">
          –î–∞—Ç–∞: ${inc.date || '‚Äî'} ‚Ä¢ –ß–∞—Å—Ç–æ—Ç–∞: ${freqMap[inc.frequency] || ''}
        </div>
        <div class="muted">
          –û—Ü–µ–Ω–∫–∞ –≤ –º–µ—Å—è—Ü: <span class="success">${formatMoney(monthly)}</span>
        </div>
        <div style="margin-top:4px; display:flex; justify-content:flex-end;">
          <button class="secondary" data-remove-inc="${idx}">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
      `;

      list.appendChild(div);
    });

    document.getElementById('tab-btn-incomes').textContent = `–î–æ—Ö–æ–¥—ã (${state.incomes.length})`;
  }

  function renderAll() {
    renderDashboard();
    renderDeposits();
    renderLoans();
    renderIncomes();
  }

  // --- Tabs & MainButton ---
  function setTab(tab) {
    currentTab = tab;
    document.querySelectorAll('.tab').forEach(t => {
      t.classList.toggle('active', t.dataset.tab === tab);
    });
    document.getElementById('tab-deposits').style.display = tab === 'deposits' ? '' : 'none';
    document.getElementById('tab-loans').style.display = tab === 'loans' ? '' : 'none';
    document.getElementById('tab-incomes').style.display = tab === 'incomes' ? '' : 'none';

    if (tg) {
      const textMap = {
        deposits: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–∫–ª–∞–¥',
        loans: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫—Ä–µ–¥–∏—Ç',
        incomes: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–æ—Ö–æ–¥'
      };
      tg.MainButton.setText(textMap[tab] || '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å');
      tg.MainButton.show();
    }
  }

  document.querySelectorAll('.tab').forEach(tabEl => {
    tabEl.addEventListener('click', () => {
      setTab(tabEl.dataset.tab);
    });
  });

  if (tg) {
    tg.MainButton.onClick(() => {
      if (currentTab === 'deposits') document.getElementById('dep-add-btn').click();
      if (currentTab === 'loans') document.getElementById('loan-add-btn').click();
      if (currentTab === 'incomes') document.getElementById('inc-add-btn').click();
    });
  }

  // --- Dashboard details toggle ---
  document.getElementById('dashboard-details-toggle').addEventListener('click', () => {
    const box = document.getElementById('dashboard-kpis-details');
    const opened = box.style.display !== 'none';
    box.style.display = opened ? 'none' : 'block';
    document.getElementById('dashboard-details-toggle').textContent =
      opened ? '–ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏' : '–°–∫—Ä—ã—Ç—å –¥–µ—Ç–∞–ª–∏';
  });

  // --- Deposit preview ---
  function updateDepositPreview() {
    const amount = parseFloat(document.getElementById('dep-amount').value) || 0;
    const rate = parseFloat(document.getElementById('dep-rate').value) || 0;
    const termValue = parseFloat(document.getElementById('dep-term-value').value) || 0;
    const termUnit = document.getElementById('dep-term-unit').value;
    const preview = document.getElementById('dep-preview');

    if (amount > 0 && rate > 0 && termValue > 0) {
      let months = termUnit === 'weeks' ? termValue / 4.345 : termValue;
      if (months <= 0) months = 0;
      const years = months / 12;
      const interest = amount * (rate / 100) * years;
      const future = amount + interest;
      const monthly = months > 0 ? interest / months : 0;

      document.getElementById('dep-preview-future').textContent =
        formatMoney(Math.round(future));
      document.getElementById('dep-preview-profit').textContent =
        '+' + formatMoney(Math.round(interest)).replace('‚ÇΩ', '').trim() + ' ‚ÇΩ';
      document.getElementById('dep-preview-monthly').textContent =
        formatMoney(Math.round(monthly)) + '/–º–µ—Å';

      preview.style.display = 'block';
    } else {
      preview.style.display = 'none';
    }
  }

  ['dep-amount', 'dep-rate', 'dep-term-value', 'dep-term-unit'].forEach(id => {
    document.getElementById(id).addEventListener('input', updateDepositPreview);
  });

  document.getElementById('dep-reset-btn').addEventListener('click', () => {
    document.getElementById('dep-name').value = '';
    document.getElementById('dep-amount').value = '';
    document.getElementById('dep-rate').value = '';
    document.getElementById('dep-term-value').value = '';
    document.getElementById('dep-term-unit').value = 'months';
    setDefaultDate('dep-start-date');
    document.getElementById('dep-preview').style.display = 'none';
  });

  // --- Handlers: add deposit ---
  document.getElementById('dep-add-btn').addEventListener('click', () => {
    const name = document.getElementById('dep-name').value.trim();
    const amountEl = document.getElementById('dep-amount');
    const rateEl = document.getElementById('dep-rate');
    const termValEl = document.getElementById('dep-term-value');
    const termUnit = document.getElementById('dep-term-unit').value;
    const startDate = document.getElementById('dep-start-date').value;

    const amount = amountEl.value;
    const rate = rateEl.value;
    const termValue = termValEl.value;

    let ok = true;
    if (!amount) { showFieldError(amountEl, '–£–∫–∞–∂–∏ —Å—É–º–º—É'); ok = false; }
    if (!rate) { showFieldError(rateEl, '–£–∫–∞–∂–∏ —Å—Ç–∞–≤–∫—É'); ok = false; }
    if (!termValue) { showFieldError(termValEl, '–£–∫–∞–∂–∏ —Å—Ä–æ–∫'); ok = false; }
    if (!ok) return;

    const id = Date.now();
    state.deposits.push({
      id,
      name,
      amount,
      rate_apy: rate,
      term_value: termValue,
      term_unit: termUnit,
      start_date: startDate
    });

    lastAdded = { type: 'dep', id };

    document.getElementById('dep-name').value = '';
    amountEl.value = '';
    rateEl.value = '';
    termValEl.value = '';
    document.getElementById('dep-term-unit').value = 'months';
    setDefaultDate('dep-start-date');
    document.getElementById('dep-preview').style.display = 'none';

    saveState();
  });

  // --- Handlers: add loan ---
  document.getElementById('loan-add-btn').addEventListener('click', () => {
    const name = document.getElementById('loan-name').value.trim();
    const principalEl = document.getElementById('loan-principal');
    const balanceEl = document.getElementById('loan-balance');
    const rateEl = document.getElementById('loan-rate');
    const monthlyEl = document.getElementById('loan-monthly');
    const startDate = document.getElementById('loan-start-date').value;

    const principal = principalEl.value;
    let balance = balanceEl.value;
    const rate = rateEl.value;
    const monthly = monthlyEl.value;

    let ok = true;
    if (!principal) { showFieldError(principalEl, '–£–∫–∞–∂–∏ —Å—É–º–º—É –∫—Ä–µ–¥–∏—Ç–∞'); ok = false; }
    if (!monthly) { showFieldError(monthlyEl, '–£–∫–∞–∂–∏ –µ–∂–µ–º–µ—Å—è—á–Ω—ã–π –ø–ª–∞—Ç—ë–∂'); ok = false; }
    if (!ok) return;

    if (!balance) balance = principal;

    const id = Date.now();
    state.loans.push({
      id,
      name,
      initial_amount: principal,
      current_balance: balance,
      rate_apy: rate,
      monthly_payment: monthly,
      start_date: startDate
    });

    lastAdded = { type: 'loan', id };

    document.getElementById('loan-name').value = '';
    principalEl.value = '';
    balanceEl.value = '';
    rateEl.value = '';
    monthlyEl.value = '';
    setDefaultDate('loan-start-date');

    saveState();
  });

  // --- Handlers: add income ---
  document.getElementById('inc-add-btn').addEventListener('click', () => {
    const name = document.getElementById('inc-name').value.trim();
    const type = document.getElementById('inc-type').value;
    const amountEl = document.getElementById('inc-amount');
    const date = document.getElementById('inc-date').value;
    const freq = document.getElementById('inc-frequency').value;

    const amount = amountEl.value;
    if (!amount) {
      showFieldError(amountEl, '–£–∫–∞–∂–∏ —Å—É–º–º—É –¥–æ—Ö–æ–¥–∞');
      return;
    }

    const id = Date.now();
    state.incomes.push({
      id,
      name,
      type,
      amount,
      date,
      frequency: freq
    });

    lastAdded = { type: 'inc', id };

    document.getElementById('inc-name').value = '';
    amountEl.value = '';
    setDefaultDate('inc-date');
    document.getElementById('inc-type').value = 'salary';
    document.getElementById('inc-frequency').value = 'once';

    saveState();
  });

  // --- Deletes ---
  document.getElementById('dep-list').addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-remove-dep]');
    if (!btn) return;
    const idx = Number(btn.getAttribute('data-remove-dep'));
    const item = state.deposits[idx];
    if (!isNaN(idx) && item) {
      const title = item.name || '–≤–∫–ª–∞–¥';
      if (confirm(`–£–¥–∞–ª–∏—Ç—å ${title}?`)) {
        state.deposits.splice(idx, 1);
        saveState();
      }
    }
  });

  document.getElementById('loan-list').addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-remove-loan]');
    if (!btn) return;
    const idx = Number(btn.getAttribute('data-remove-loan'));
    const item = state.loans[idx];
    if (!isNaN(idx) && item) {
      const title = item.name || '–∫—Ä–µ–¥–∏—Ç';
      if (confirm(`–£–¥–∞–ª–∏—Ç—å ${title}?`)) {
        state.loans.splice(idx, 1);
        saveState();
      }
    }
  });

  document.getElementById('inc-list').addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-remove-inc]');
    if (!btn) return;
    const idx = Number(btn.getAttribute('data-remove-inc'));
    const item = state.incomes[idx];
    if (!isNaN(idx) && item) {
      const title = item.name || '–¥–æ—Ö–æ–¥';
      if (confirm(`–£–¥–∞–ª–∏—Ç—å ${title}?`)) {
        state.incomes.splice(idx, 1);
        saveState();
      }
    }
  });

  // --- –®–∞–±–ª–æ–Ω –±—ã—Å—Ç—Ä–æ–≥–æ –≤–∫–ª–∞–¥–∞ ---
  function applyDepositSuggestion(amount, rate, months) {
    document.getElementById('dep-amount').value = amount;
    document.getElementById('dep-rate').value = rate;
    document.getElementById('dep-term-value').value = months;
    document.getElementById('dep-term-unit').value = 'months';
    updateDepositPreview();
    document.getElementById('dep-name').scrollIntoView({ behavior: 'smooth', block: 'center' });
    document.getElementById('dep-name').focus();
  }
  window.applyDepositSuggestion = applyDepositSuggestion;

  // --- Init ---
  loadState();
  renderAll();
  setTab('deposits');
</script>
</body>
</html>
